FROM alpine:latest

EXPOSE 3000

ENV GOPATH=/tmp/go

RUN set -ex \
    && apk add --update --no-cache bash \
    && apk add --update --no-cache --virtual .build-deps \
        rsync \
        git \
        go \
        build-base \
    && apk add mysql-client \
    && cd /tmp \
    && { go get -d github.com/github/orchestrator ; : ; } \
    && cd $GOPATH/src/github.com/github/orchestrator \
    && bash build.sh -b \
    && mkdir -p /usr/local/orchestrator \
    && cp build/bin/orchestrator /usr/local/orchestrator/ \
    && cd / \
    && apk del .build-deps \
    && rm -rf /tmp/* \
    && mkdir -p /var/lib/orchestrator

WORKDIR /usr/local/orchestrator
CMD /usr/local/orchestrator/orchestrator http

